<h2> NTE ymx expression test</h2>
<h4>layer 2</h4>

x: <input bind="x" link="line,y" require="#x,#m"><br>
m: <input bind="m" link="line_or_reverse,y,x" require="#m,(#y|#x)" update="change,blur" default="1"><br>
y: <input bind="y" link="reverse_line,x" require="#y,#m" enableIf="m" _debug="link"><br>

<p>first name: <input bind="fName" link="fullName"><br></p>
<p>last name: <input bind="lName" link="fullName"><br></p>
<p>full name: <input bind="fullName" enableIf="fname,lname" readonly></p>

<p>Even KO can be expanded with extra binders. What I will like to do is split, reduce and concentrate to write more simple code.
Inline complex expressions are not allowed. </p>

<script>

	var app = new function() {
		
		var me = this;
				
		/** properties **/
		
		me.x = 3
		
		/** private **/
		
		function xNaN() { return isNaN( me.x || 'a' ) }
		function yNaN() { return isNaN( me.y || 'a' ) }
		
		/** public **/
	
		me.line = function () { me.y = me.x * me.m }
	
		me.line_or_reverse = function() {
			if (!xNaN()) 
				me.y = me.m * me.x;
			else {
				if (!yNaN()) me.x = me.y / me.m;
			}
		}
		
		me.reverse_line = function() { me.x = me.y / me.m }
		
		me.fullName = function() { return me.fName + " " + me.lName }
		
	}
	
</script>

<!-- expected generated code -->
<script> 

	(function() {

			var $mdl = app;
		
			/** binds **/
		
			var x = document.querySelector("input[bind='x']");
			var m = document.querySelector("input[bind='m']");		
			var y = document.querySelector("input[bind='y']");

			var fName = document.querySelector("input[bind='fName']");
			var lName = document.querySelector("input[bind='lName']");
			var fullName = document.querySelector("input[bind='fullName']");
						
			/** utils **/
		
			function $set(element,value) {
				if (value !== undefined) element.value = value;
			}
				
			function $upd( input, value ) {
				if (value !== undefined && input.value != value) {
					input.value = value;
					input.dispatchEvent(new Event('change'))
				}
			}
		
			function $disableIf( ) {
				for (var i=0;i<arguments.length;i++) {
					value = arguments[i];
					if (value === undefined || value == 0 || value == "" || value == null)
						return true;
				}
				return false;
			}
		
			/** requires **/
		
			function $requires_for_x() {
				var b = !isNaN( x.value||'a' ) && !isNaN( m.value||'a' ) 
				return b;
			}
		
			function $requires_for_m() {
				var b = !isNaN( m.value||'a' ) && ( !isNaN( x.value||'a' ) || !isNaN( y.value||'a' ) )
				return b;
			}
		
			function $requires_for_y() {
				var b = !isNaN( y.value||'a' ) && !isNaN( m.value||'a' ) 
				return b;
			}
		
			/** enableIf **/
			
			function $disables_for_m() {
				y.disabled = $disableIf($mdl.m);
			}
			
			function $disables_for_fullName() {
				fullName.disabled = $disableIf($mdl.fName, $mdl.lName);
			}
		
			/** links  **/
		
			function $links_for_x( ev ) {
				$mdl.x = this.value;
				if (!$requires_for_x()) return;
				$mdl.line();
				$set( y, $mdl.y );
			}
		
			function $links_for_m( ev ) {
				$mdl.m = this.value;
				if (!$requires_for_m()) return;
				$mdl.line_or_reverse();
				$set( y, $mdl.y );
				$set( x, $mdl.x );
				$disables_for_m();
			}
		
			function $links_for_y( ev ) {
				$mdl.y = this.value;
				if (!$requires_for_y()) return;
				$mdl.reverse_line();
				$set(x,$mdl.x);
			}
			
			function $links_for_fName( ev ) {
				$mdl.fName = this.value;
				fullName.value = $mdl.fullName()
			}

			function $links_for_lName( ev ) {
				$mdl.lName = this.value;
				fullName.value = $mdl.fullName()
			}
					
			/** defaults **/

			$mdl.m = 1; 

			/** events **/

			x.addEventListener('change', $links_for_x )
			m.addEventListener('change', $links_for_m )
			m.addEventListener('blur', $links_for_m )
			y.addEventListener('change', $links_for_y )
			fName.addEventListener('change', $links_for_fName )
			lName.addEventListener('change', $links_for_lName )
						
			/** init **/		
		
			$upd( x, $mdl.x );
			$upd( m, $mdl.m );
			$upd( y, $mdl.y );
			
			$upd( fName, $mdl.fName );
			$upd( lName, $mdl.lName );
			$upd( fullName, $mdl.fullName() );
			
	})();
</script>
	
<!-- ######################################################################## -->

<template id="nte.models">

	<script id="bind" type="text/jtl">
		var @name = document.querySelector("input[bind='@name']");
	</script>

	<script id="init" type="text/jtl">
		$upd( @name, $mdl.@name );
	</script>
	
	<script id="require" type="text/jtl">
		function $requires_for_@name() {
			var b = @expression;
			return b;
		}
	</script>
	
	<script id="enebleIf" type="text/jtl">
		function $disables_for_@name() {
			@name.disabled = $disableIf($mdl.m);
		}
	</script>
	
	<script id="main" type="text/jtl">
		(function() {

			var $mdl = app;
		
			/** binds **/
			
			@binds
		
			/** utils **/
		
			function $set(element,value) {
				if (value !== undefined) element.value = value;
			}
				
			function $upd( input, value ) {
				if (value !== undefined && input.value != value) {
					input.value = value;
					input.dispatchEvent(new Event('change'))
				}
			}
		
			function $disableIf( ) {
				for (var i=0;i<arguments.length;i++) {
					value = arguments[i];
					if (value === undefined || value == 0 || value == "" || value == null)
						return true;
				}
				return false;
			}
		
			/** requires **/
			
			@requires
				
			/** enableIf **/
			
			@disables
		
			/** links  **/
		
			@links
		
			/** defaults **/

			@defaults 

			/** events **/

			@events

			/** init **/		
		
			@inits
		
		})();
	</script>
</template>

<script type="text">

	(function(){
		
		var model = document.querySelector("#nte\\.models");
		var nodes = {
			main: model.content.getElementById("main"),
			bind: model.content.getElementById("bind"),
			init: model.content.getElementById("init"),
			require: model.content.getElementById("require"),
		}
		
		for (var node in nodes) {
			if (nodes[node] === null) {
				throw("\nTemplate model for '"+node+"' not specified.\nPlease check template 'nte.models'.");
			}
		}
			
		var main = nodes.main.innerText.trim()
		var bind = nodes.bind.innerText.trim()+"\n"
		var init = nodes.init.innerText.trim()+"\n"
				
		var tags = document.getElementsByTagName("input")
		
		var binds = ""
		var inits = ""
		
		for (var i=0;i<tags.length;i++) {
		
			var node = tags[i];
			
			if (node.attributes.bind !== undefined) {
				binds += bind.replace( /@name/g, node.attributes.bind.value )
				inits += init.replace( /@name/g, node.attributes.bind.value )
			}
			
		}
		
		main = main
				.replace( /@binds/g, binds )
				.replace( /@inits/g, inits )
		
		var script = document.createElement("SCRIPT");
		script.innerText = main;
		
		document.append( script );
		
	})()
	
</script>

